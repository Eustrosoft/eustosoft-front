<!--
  ~ Copyright (c) 2023. IdrisovII & EustroSoft.org
  ~
  ~ This file is part of eustrosoft-front project.
  ~ See the LICENSE file at the project root for licensing information.
  -->

<div class="d-flex flex-column h-inherit">
  <div class="flex-grow-0 flex-shrink-0 bg-secondary bg-opacity-25 rounded-top">
    <div class="d-flex align-items-center justify-content-between ps-2">
      <div class="d-flex align-items-center">
        <eustrosoft-front-button
          [buttonType]="'button'"
          [buttonStyleType]="'icon'"
          [iconName]="'menu'"
          class="d-sm-none"
          (clicked)="collapseClicked.emit()"
        ></eustrosoft-front-button>
        <h2 class="mb-0">
          {{ selectedTicket && selectedTicket.title }}
        </h2>
      </div>
      <div class="d-flex align-items-center">
        <eustrosoft-front-button
          [buttonType]="'button'"
          [buttonStyleType]="'icon'"
          [iconName]="'more_vert'"
          [matMenuTriggerFor]="ticketActionsMenu"
          [hidden]="!selectedTicket"
        ></eustrosoft-front-button>
        <mat-menu #ticketActionsMenu="matMenu">
          <button mat-menu-item>
            <mat-icon>cancel</mat-icon>
            <span>Close ticket</span>
          </button>
        </mat-menu>
      </div>
    </div>
  </div>
  <div class="flex-grow-1 h-100 bg-secondary bg-opacity-10">
    <div
      *ngIf="selectedTicket; else noSelectedTicketTemplate"
      class="d-flex flex-column justify-content-between h-inherit"
    >
      <cdk-virtual-scroll-viewport
        class="d-flex flex-column justify-content-end h-100"
        itemSize="50"
        #messagesVirtualScrollViewport
      >
        <ng-container *cdkVirtualFor="let msg of selectedTicketMessages">
          <ng-container [ngSwitch]="msg.author">
            <div
              *ngSwitchCase="msgAuthor.ME"
              class="d-flex justify-content-end m-2 list-message-item"
            >
              <ng-container
                [ngTemplateOutlet]="msgTemplate"
                [ngTemplateOutletContext]="{ $implicit: msg }"
              ></ng-container>
            </div>
            <div *ngSwitchDefault class="d-flex m-2 list-message-item">
              <ng-container
                [ngTemplateOutlet]="msgTemplate"
                [ngTemplateOutletContext]="{ $implicit: msg }"
              ></ng-container>
            </div>
          </ng-container>
        </ng-container>
      </cdk-virtual-scroll-viewport>
      <div class="d-flex align-items-center p-3 pe-1">
        <eustrosoft-front-input
          [fieldAppearance]="'outline'"
          [control]="control"
          [placeholder]="'Write a message...'"
          class="flex-grow-1"
        ></eustrosoft-front-input>
        <eustrosoft-front-button
          [buttonType]="'button'"
          [buttonStyleType]="'icon'"
          [iconName]="'send'"
        ></eustrosoft-front-button>
      </div>
    </div>
  </div>
</div>
<ng-template #msgTemplate let-msg>
  <div class="d-flex flex-column mw-45">
    <div class="p-2 bg-light rounded-1">
      <span>{{ msg.message }}</span>
      <div class="d-flex justify-content-end">
        <span class="fw-light fst-italic">{{ msg.author }}</span>
        <!--      <span class="fw-light">{{ msg.messageDateTime | date : 'short' }}</span>-->
      </div>
    </div>
  </div>
</ng-template>

<ng-template #noSelectedTicketTemplate>
  <div
    class="d-flex flex-column align-items-center justify-content-center h-inherit"
  >
    <h2>Select ticket from menu</h2>
  </div>
</ng-template>
